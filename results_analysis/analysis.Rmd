---
title: "Analysis"
author: "Stuart Miller, Paul Adams, Rikel Djoko"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, setup_, echo=FALSE, message=FALSE}
library(pwr2)
library(tidyverse)
```

# Power Analysis

The power analysis for this project was done using R package (pwr2).

https://cran.r-project.org/web/packages/pwr2/pwr2.pdf


```{r, power_analysis}

pwr.2way(a=2, b=3, alpha=0.05, size.A=30, size.B=30, f.A=NULL, f.B=NULL,
delta.A=4, delta.B=2, sigma.A=2, sigma.B=2)
```


# Results of Study

```{r, load_data}
data <- read_csv('./results_sample.csv',
                 col_types = cols(
                   schema = col_factor(levels = c('normal','Non-normal')),
                   block_size = col_factor(levels = c('64','128','256')),
                   time = col_double()
                 )
        )
```

## Summary Stats for the Levels

This is assuming that schema is the main driving factor of variation.

```{r, summary_stats}
data %>% 
  group_by(schema, block_size) %>% 
  summarise(mean_time = mean(time),
            median_time = median(time),
            IQR_time = IQR(time))
```

## 2-Way ANOVA Profile Plot

Profile plot is colored by schema.

```{r, profile_plot}
mysummary<-function(x){
  result<-c(length(x),mean(x),sd(x),sd(x)/length(x),min(x),max(x),IQR(x))
  names(result)<-c("N","Mean","SD","SE","Min","Max","IQR")
  return(result)
}

sumstats<-aggregate(time ~ schema:block_size, data=data, mysummary)
sumstats<-cbind(sumstats[,1:2],sumstats[,-(1:2)])

ggplot(sumstats,aes(x=block_size,y=Mean,group=schema,color=schema)) +
  ylab("Query Time (seconds)") +
  xlab("MapReduce Block Size (MB)") +
  ggtitle('Query Time for Schemas and MapReduce Settings') +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin=Mean-SD,ymax=Mean+SD),width=.1)
```


## Fit the ANOVA on the Data

This assumes data replication with schema as the primary source of variation.

```{r, anova}
analysis.aov <- data %>% 
  aov(time ~ schema + Error(block_size/schema), data = .)

aov.summ <- summary(analysis.aov)
aov.summ
```

## Plot Multiple Comparisons

This doesn't correct for mutliple comparisons?

```{r, mult_compare}
analysis.aov <- data %>% 
  aov(time ~ schema:block_size, data = .)

with(par(mai=c(1,2.5,1,1)),
     {plot(TukeyHSD(analysis.aov),
           las=1,
           cex.axis=0.4)
       }
     )
```






